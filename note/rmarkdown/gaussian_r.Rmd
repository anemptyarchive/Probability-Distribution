---
title: "1次元ガウス分布"
author: "@anemptyarchive\\thanks{\\url{https://www.anarchive-beta.com/}}"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output:
  html_document:
    toc: TRUE       # 目次
    toc_depth: 3    # 目次の見出しレベル
    toc_float: TRUE # 目次のスクロール追跡
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  message = FALSE, error = FALSE, warning = FALSE # メッセージを非表示
)
```

----

【編集履歴】

- 2022/01/28：執筆開始
- 2022/01/30：初稿
- 2022/07/31：Rコードを改修

----


# 1次元ガウス分布の計算

　1次元ガウス分布(Gaussian Distribution)の確率密度と統計量を計算します。ガウス分布については「定義式の確認」を参照してください。\
\


## 確率密度の計算

　ガウス分布に従う確率密度を計算する方法をいくつか確認します。\
\


### 標準偏差パラメータを使用

　まずは、標準偏差パラメータを用いてガウス分布を計算します。\
\


#### パラメータの設定

　ガウス分布のパラメータ$\mu, \sigma$と確率変数の実現値$x$を設定します。

```{r}
# 平均パラメータを指定
mu <- 2

# 標準偏差パラメータを指定
sigma <- 0.5

# 確率変数の値を指定
x <- 1.5
```

　平均パラメータ(実数)$\mu$と標準偏差パラメータ(正の実数)$\sigma$、確率変数の値(実数)$x$を指定します。設定した値に従う確率密度を計算します。\
\


#### スクラッチで計算

　定義式から計算します。

```{r}
# 定義式により確率密度を計算
C    <- 1 / sqrt(2 * pi * sigma^2)
dens <- C * exp(-0.5 * (x - mu)^2 / sigma^2)
dens
```

　ガウス分布は、次の式で定義されます。

$$
\begin{aligned}
C_{\mathcal{N}}
   &= \frac{1}{\sqrt{2 \pi \sigma^2}}
\\
\mathcal{N}(x | \mu, \sigma^2)
   &= C_{\mathcal{N}}
      \exp \left\{
          - \frac{(x - \mu)^2}{2 \sigma^2}
      \right\}
\end{aligned}
$$

　ここで、$C_{\mathcal{N}}$はガウス分布の正規化係数、$\pi$は円周率です。\
　円周率は`pi`で利用できます。\

　対数をとった定義式から計算します。

```{r}
# 対数をとった定義式により確率密度を計算
log_C    <- -0.5 * log(2 * pi) - log(sigma)
log_dens <- log_C - 0.5 * (x - mu)^2 / sigma^2
dens     <- exp(log_dens)
dens; log_dens
```

　対数をとった定義式を計算します。

$$
\begin{aligned}
\log C_{\mathcal{N}}
   &= - \frac{\log (2 \pi)}{2}
      - \log \sigma
\\
\log \mathcal{N}(x | \mu, \sigma^2)
   &= \log C_{\mathcal{N}}
      - \frac{(x - \mu)^2}{2 \sigma^2}
\end{aligned}
$$

　計算結果の指数をとると確率密度が得られます。

$$
\mathcal{N}(x | \mu, \sigma^2)
    = \exp \Bigr(
          \log \mathcal{N}(x | \mu, \sigma^2)
      \Bigr)
$$

　指数と対数の性質より$\exp(\log x) = x$です。\

　次は、関数を使って確率密度を計算します。\
\


#### ガウス分布の関数による計算

　ガウス分布の確率密度関数`dnorm()`で計算します。

```{r}
# ガウス分布の関数により確率密度を計算
dens <- dnorm(x = x, mean = mu, sd = sigma)
dens
```

　確率変数の引数`x`に`x`、平均の引数`mean`に`mu`、標準偏差の引数`sd`に`sigma`を指定します。\

　`log = TRUE`を指定すると対数をとった確率密度を返します。

```{r}
# ガウス分布の対数をとった関数により確率密度を計算
log_dens <- dnorm(x = x, mean = mu, sd = sigma, log = TRUE)
dens     <- exp(log_dens)
dens; log_dens
```

　計算結果の指数をとると確率密度が得られます。\

　標準正規分布を使って計算することもできます。

```{r}
# 標準正規分布の関数により確率密度を計算
y    <- (x - mu) / sigma # 標準化
dens <- dnorm(x = y, mean = 0, sd = 1) / sigma
dens
```

　$x$を$\mu, \lambda$で標準化して$y$とします。平均0・標準偏差1(分散1)のときの$y$の確率密度(分布)$\mathcal{N}(y | 0, 1)$を$\sigma$で割ると、平均$\mu$・標準偏差$\sigma$(分散$\sigma^2$)のときの$x$の確率密度(分布)$\mathcal{N}(x | \mu, \sigma)$が得られます。  
\


### 精度パラメータを使用

　続いて、精度パラメータを用いてガウス分布を計算します。\
\


#### パラメータの設定

　ガウス分布のパラメータ$\mu, \lambda$と確率変数の実現値$x$を設定します。

```{r}
# 平均パラメータを指定
mu <- 2

# 精度パラメータを指定
lambda <- 4

# 確率変数の値を指定
x <- 1.5
```

　標準偏差パラメータ$\sigma$の代わりに、精度パラメータ(正の実数)$\lambda$を指定します。\

　あるいは、$\sigma$を指定して$\lambda$を計算します。

```{r}
# 精度パラメータを計算
lambda <- 1 / sigma^2
lambda
```

　標準偏差パラメータ$\sigma$と精度パラメータ$\lambda$は、$\lambda = \frac{1}{\sigma^2}$、$\sigma = \frac{1}{\sqrt{\lambda}}$の関係です。\
\


#### スクラッチで計算

　定義式から計算します。

```{r}
# 定義式により確率密度を計算
C    <- sqrt(lambda / 2 / pi)
dens <- C * exp(-0.5 * lambda * (x - mu)^2)
dens
```

　ガウス分布は、次の式で定義されます。

$$
\begin{aligned}
C_{\mathcal{N}}
   &= \Bigl(
          \frac{\lambda}{2 \pi}
      \Bigr)^{\frac{1}{2}}
\\
\mathcal{N}(x | \mu, \lambda^{-1})
   &= C_{\mathcal{N}}
      \exp \left\{
          - \frac{\lambda (x - \mu)^2}{2}
      \right\}
\end{aligned}
$$

　平方根は$\sqrt{x} = x^{\frac{1}{2}}$です。\

　対数をとった定義式から計算します。

```{r}
# 対数をとった定義式により確率密度を計算
log_C    <- -0.5 * (log(2 * pi) - log(lambda))
log_dens <- log_C - 0.5 * lambda * (x - mu)^2
dens     <- exp(log_dens)
dens; log_dens
```

　対数をとった定義式を計算します。

$$
\begin{aligned}
\log C_{\mathcal{N}}
   &= - \frac{1}{2} \Bigl\{
          \log (2 \pi) - \log \lambda
      \Bigr\}
\\
\log \mathcal{N}(x | \mu, \lambda^{-1})
   &= \log C_{\mathcal{N}}
      - \frac{\lambda (x - \mu)^2}{2}
\end{aligned}
$$

　計算結果の指数をとると確率密度が得られます。\
\


#### ガウス分布の関数による計算

　ガウス分布の確率密度関数`dnorm()`で計算します。

```{r}
# ガウス分布の関数により確率密度を計算
dens <- dnorm(x = x, mean = mu, sd = 1/sqrt(lambda))
dens

# ガウス分布の対数をとった関数により確率密度を計算
log_dens <- dnorm(x = x, mean = mu, sd = 1/sqrt(lambda), log = TRUE)
dens     <- exp(log_dens)
dens; log_dens
```

　標準偏差の引数`sd`に`lambda`の平方根の逆数を指定します。\

　標準正規分布を使って計算することもできます。

```{r}
# 標準正規分布の関数により確率密度を計算
y    <- (x - mu) * sqrt(lambda) # 標準化
dens <- dnorm(x = y, mean = 0, sd = 1) * sqrt(lambda)
dens
```

　$x$を$\mu, \sigma$で標準化して$y$とします。平均0・精度1(分散1)のときの$y$の確率密度(分布)$\mathcal{N}(y | 0, 1)$に$\lambda$の平方根を掛けると、平均$\mu$・精度$\lambda$(分散$\lambda^{-1}$)のときの$x$の確率密度(分布)$\mathcal{N}(x | \mu, \lambda^{-1})$が得られます。  
\


## 統計量の計算

　次は、ガウス分布の期待値・分散・精度を計算します。詳しくは「統計量の導出」を参照してください。\
\

　標準偏差パラメータを使って、分散パラメータを計算します。

```{r}
# 標準偏差から分散を計算
sigma2 <- sigma^2
sigma2
```

　分散は、標準偏差の2乗です。

$$
\mathbb{V}[x]
    = \sigma^2
$$

　分散パラメータを使って、精度パラメータを計算します。

```{r}
# 分散から精度を計算
lambda <- 1 / sigma2
lambda
```

　精度は、分散の逆数です。

$$
\lambda
    = \frac{1}{\sigma^2}
$$

　精度パラメータを使って、標準偏差パラメータを計算します。

```{r}
# 精度から標準偏差を計算
sigma <- 1 / sqrt(lambda)
sigma
```

　標準偏差は、精度の平方根の逆数で計算できます。

$$
\sigma
    = \frac{1}{\sqrt{\lambda}}
$$

　元の値になるのを確認できました。\
\

　この記事では、ガウス分布の計算を確認しました。次は、グラフを作成します。\
\


# 1次元ガウス分布の作図

　1次元ガウス分布(Gaussian Distribution)のグラフを作成します。ガウス分布については「定義式の確認」を参照してください。\
\

　利用するパッケージを読み込みます。

```{r, eval=FALSE}
# 利用パッケージ
library(tidyverse)
library(gganimate)
```

```{r, echo=FALSE}
### 資料作成用

# チェック用
library(ggplot2)
```

　この記事では、基本的に`パッケージ名::関数名()`の記法を使うので、パッケージを読み込む必要はありません。ただし、作図コードがごちゃごちゃしないようにパッケージ名を省略しているため、`ggplot2`は読み込む必要があります。\
　`magrittr`パッケージのパイプ演算子`%>%`ではなく、ベースパイプ(ネイティブパイプ)演算子`|>`を使っています。`%>%`に置き換えても処理できます。\
　分布の変化をアニメーション(gif画像)で確認するのに`gganimate`パッケージを利用します。不要であれば省略してください。\
\


## 定義式の確認

　まずは、ガウス分布の定義式を確認します。\
\

　ガウス分布は、次の式で定義されます。

$$
\mathcal{N}(x | \mu, \sigma^2)
    = \frac{1}{\sqrt{2 \pi \sigma^2}}
      \exp \left\{
          - \frac{(x - \mu)^2}{2 \sigma^2}
      \right\}
$$

　ここで、$\mu$は平均パラメータ、$\sigma$は標準偏差パラメータ、$\pi$は円周率です。$\sigma$の2乗を分散パラメータ$\sigma^2$、分散パラメータの逆数を精度パラメータ$\lambda = \frac{1}{\sigma^2}$と呼びます。\
　$x$は実数をとり、$\mu$は実数、$\sigma$は正の実数を満たす必要があります。\

　ガウス分布の期待値・分散・最頻値は、次の式で計算できます。詳しくはいつか書きます。

$$
\begin{aligned}
\mathbb{E}[x]
   &= \mu
\\
\mathbb{V}[x]
   &= \sigma^2
\\
\mathrm{mode}[x]
   &= \mu
\end{aligned}
$$

　これらの計算を行いグラフを作成します。\
\


## グラフの作成

　`ggplot2`パッケージを利用して、ガウス分布のグラフを作成します。ガウス分布の確率や統計量の計算については「ガウス分布の計算」を参照してください。\
\

　ガウス分布のパラメータ$\mu, \sigma$を設定します。

```{r}
# 平均パラメータを指定
mu <- 0

# 標準偏差パラメータを指定
sigma <- 1
```

　平均パラメータ(実数)$\mu$と標準偏差パラメータ(正の実数)$\sigma$を計算します。\

　ガウス分布の確率変数がとり得る値$x$を作成します。

```{r}
# xの値を作成
x_vals <- seq(from = mu - sigma*4, to = mu + sigma*4, length.out = 251)
```

　実数$x$の値を作成して`x_vals`とします。この例では、`mu`を中心に`4`倍を範囲とします。\

　$x$の値ごとの確率密度を計算します。

```{r}
# ガウス分布を計算
dens_df <- tidyr::tibble(
  x = x_vals, # 確率変数
  density = dnorm(x = x_vals, mean = mu, sd = sigma) # 確率密度
)
dens_df
```

　ガウス分布の確率密度は、`dnorm()`で計算できます。確率変数の引数`x`に`x_vals`、平均の引数`mean`に`mu`、標準偏差の引数`sd`に`sigma`を指定します。\
　`x_vals`と、`x_vals`の各要素に対応する確率密度をデータフレームに格納します。\

　ガウス分布のグラフを作成します。

```{r, fig.width=8, fig.height=6}
# ガウス分布のグラフを作成
ggplot(data = dens_df, mapping = aes(x = x, y = density)) + # データ
  geom_line(color = "#00A968", size = 1) + # 折れ線グラフ
  labs(
    title = "Gaussian Distribution", 
    subtitle = paste0("mu=", mu, ", sigma=", sigma), # (文字列表記用)
    #subtitle = parse(text = paste0("list(mu==", mu, ", sigma==", sigma, ")")), # (数式表記用)
    x = "x", y = "density"
  ) # ラベル
```

　ギリシャ文字などの記号を使った数式を表示する場合は、`expression()`の記法を使います。等号は`"=="`、複数の(数式上の)変数を並べるには`"list(変数1, 変数2)"`とします。(プログラム上の)変数の値を使う場合は、`parse()`の`text`引数に指定します。\
\

　この分布に統計量の情報を重ねて表示します。

```{r, fig.width=8, fig.height=6}
# 統計量を重ねたガウス分布のグラフを作成:線のみ
ggplot(data = dens_df, mapping = aes(x = x, y = density)) + # データ
  geom_line(color = "#00A968", size = 1) + # 分布
  geom_vline(xintercept = mu, color = "blue", size = 1, linetype = "dashed") + # 期待値
  geom_vline(xintercept = mu-sigma, color = "orange", size = 1, linetype = "dotted") + # 期待値 - 標準偏差
  geom_vline(xintercept = mu+sigma, color = "orange", size = 1, linetype = "dotted") + # 期待値 + 標準偏差
  labs(
    title = "Gaussian Distribution", 
    subtitle = parse(text = paste0("list(mu==", mu, ", sigma==", sigma, ")")), 
    x = "x", y = "density"
  ) # ラベル
```

　期待値・標準偏差(分散の平方根)を計算して、それぞれ`geom_vline()`で垂直線を引きます。標準偏差については期待値から足し引きした値を使います。\
\

　凡例を表示する場合は、垂直線を引く値をデータフレームにまとめます。

```{r}
# 統計量を格納
stat_df <- tibble::tibble(
  statistic = c(mu, mu-sigma, mu+sigma), # 統計量
  type = c("mean", "sd", "sd") # 色分け用ラベル
)
stat_df
```

　各統計量を区別するための文字列も格納します。期待値と標準偏差の差・和は同じラベルとします。\

　線の色や種類、凡例テキストを指定する場合は、設定用の名前付きベクトルを作成します。

```{r}
# 凡例用の設定を作成:(数式表示用)
color_vec    <- c(mean = "blue", sd = "orange")
linetype_vec <- c(mean = "dashed", sd = "dotted")
label_vec    <- c(mean = expression(E(x)), sd = expression(E(x) %+-% sqrt(V(x))))
color_vec; linetype_vec; label_vec
```

　各要素(設定)の名前を`type`列の文字列と対応させて、設定(線の色・種類と数式用のテキスト)を指定します。\

　凡例付きのグラフを作成します。

```{r, fig.width=8, fig.height=6}
# 統計量を重ねたポアソン分布のグラフを作成:凡例付き
ggplot() + 
  geom_line(data = dens_df, mapping = aes(x = x, y = density), 
            color = "#00A968", size = 1) + # 分布
  geom_vline(data = stat_df, mapping = aes(xintercept = statistic, color = type, linetype = type), 
             size = 1) + # 期待値
  scale_color_manual(values = color_vec, labels = label_vec, name = "statistic") + # 線の色:(色指定と数式表示用)
  scale_linetype_manual(values = linetype_vec, labels = label_vec, name = "statistic") + # 線の種類:(線指定と数式表示用)
  guides(color = guide_legend(override.aes = list(size = 0.5))) + # 凡例の体裁
  theme(legend.text.align = 0) + # 図の体裁:凡例
  labs(title = "Gaussian Distribution", 
       subtitle = parse(text = paste0("list(mu==", mu, ", sigma==", sigma, ")")), 
       x = "x", y = "density") # ラベル
```

　`scale_color_manual()`の`values`引数に線の色、`scale_linetype_manual()`の`values`引数に線の種類を指定します。凡例テキストを指定する場合は、それぞれの`labels`引数に指定します。`names`引数は凡例ラベルです。\
　凡例テキストは、`theme()`の`legend.text.align`引数に`0`を指定すると左寄せ、デフォルト(`1`)だと右寄せになります。\
\

　ガウス分布のグラフを描画できました。以降は、ここまでの作図処理を用いて、パラメータの影響を確認していきます。\
\


## パラメータと分布の関係を並べて比較

　複数のパラメータのグラフを比較することで、パラメータの値と分布の形状の関係を確認します。\
\


### 平均の影響

　複数の$\mu$を指定し、$\sigma$を固定して、それぞれ分布を計算します。

```{r}
# 平均パラメータとして利用する値を指定
mu_vals <- c(-3.5, -2, -0.5, 1, 2.5, 4)

# 標準偏差パラメータを指定
sigma <- 1

# xの値を作成
x_vals <- seq(from = min(mu_vals) - sigma*2, to = max(mu_vals) + sigma*2, length.out = 251)

# パラメータごとにガウス分布を計算
res_dens_df <- tidyr::expand_grid(
  x = x_vals, 
  mu = mu_vals
) |> # 全ての組み合わせを作成
  dplyr::arrange(mu, x) |> # パラメータごとに並べ替え
  dplyr::mutate(
    density = dnorm(x = x, mean = mu, sd = sigma), 
    parameter = paste0("mu=", mu, ", sigma=", sigma) |> 
      factor(levels = paste0("mu=", sort(mu_vals), ", sigma=", sigma)) # フレーム切替用ラベル
  ) # 確率密度を計算
res_dens_df
```

　確率変数`x_vals`とパラメータ`mu_vals`それぞれの要素の全ての組み合わせを`expand_grid()`で作成します。\
　組み合わせごとに確率密度を計算して、パラメータごとにラベルを作成します。ラベルは、グラフの設定や凡例テキストとして使います。文字列型だと文字列の基準で順序が決まるので、因子型にしてパラメータに応じたレベル(順序)を設定します。\

　凡例を数式で表示する場合は、`expression()`に対応した記法に変換します。

```{r}
# 凡例用のラベルを作成:(数式表示用)
label_vec <- res_dens_df[["parameter"]] |> 
  stringr::str_replace_all(pattern = "=", replacement = "==") |> # 等号表示用の記法に変換
  (\(.){paste0("list(", ., ")")})() |> # カンマ表示用の記法に変換
  unique() |> # 重複を除去
  parse(text = _) # expression関数化
names(label_vec) <- unique(res_dens_df[["parameter"]]) # ggplotに指定する文字列に対応する名前付きベクトルに変換
label_vec[1]
```

　変換後の文字列のベクトルに対して`names()`を使って、元の文字列を各要素の名前として設定します。\
　3行目の処理では、無名関数`function()`の省略記法`\()`を使って、`(\(引数){引数を使った具体的な処理})()`としています。直前のパイプ演算子を`%>%`にすると、行全体`(\(引数){処理})()`を`{}`の中の`処理`(この例だと`paste0("list(", ., ")")`)に置き換えられます(置き換えられるように引数名を`.`にしています)。\

　`res_prob_df`の`parameter`列の要素`mu=-3.5, sigma=1`と、変換後の文字列`list(mu == -3.5, sigma == 1)`が対応しています。\

　パラメータごとにグラフを作成します。

```{r, fig.width=8, fig.height=6}
# ガウス分布のアニメーションを作図
ggplot(data = res_dens_df, mapping = aes(x = x, y = density, color = parameter)) + # データ
  geom_line(size = 1) + # 折れ線グラフ
  scale_color_hue(labels = label_vec) + # 線の色:(数式表示用)
  theme(legend.text.align = 0) + # 図の体裁:凡例
  labs(title = "Gaussian Distribution", 
       x = "x", y = "density") # ラベル
```

　$\mu$が大きいほど山が右に移動します。\
\


### 標準偏差の影響

　続いて、$\mu$を固定し、複数の$\sigma$を指定して、それぞれ分布を計算します。

```{r}
# 平均パラメータを指定
mu <- 0

# 標準偏差パラメータとして利用する値を指定
sigma_vals <- c(0.5, 1, 2, 4)

# xの値を作成
x_vals <- seq(from = mu - max(sigma_vals)*1.5, to = mu + max(sigma_vals)*1.5, length.out = 250)

# パラメータごとにガウス分布を計算
res_dens_df <- tidyr::expand_grid(
  x = x_vals, 
  sigma = sigma_vals
) |> # 全ての組み合わせを作成
  dplyr::arrange(sigma, x) |> # パラメータごとに並べ替え
  dplyr::mutate(
    density = dnorm(x = x, mean = mu, sd = sigma), 
    parameter = paste0("mu=", mu, ", sigma=", sigma) |> 
      factor(levels = paste0("mu=", mu, ", sigma=", sort(sigma_vals))) # フレーム切替用ラベル
  ) # 確率密度を計算
res_dens_df
```

　`x_vals`と`sigma_vals`の全ての組み合わせを作成して、同様に処理します。\

　作図については同じコードで処理できます。

```{r, echo=FALSE, fig.width=8, fig.height=6}
### 資料作成用:(再掲)

# 凡例用のラベルを作成:(数式表示用)
label_vec <- res_dens_df[["parameter"]] |> 
  stringr::str_replace_all(pattern = "=", replacement = "==") |> # 等号表示用の記法に変換
  (\(.){paste0("list(", ., ")")})() |> # カンマ表示用の記法に変換
  unique() |> # 重複を除去
  parse(text = _) # expression関数化
names(label_vec) <- unique(res_dens_df[["parameter"]]) # ggplotに指定する文字列に対応する名前付きベクトルに変換

# ガウス分布のアニメーションを作図
ggplot(data = res_dens_df, mapping = aes(x = x, y = density, color = parameter)) + # データ
  geom_line(size = 1) + # 折れ線グラフ
  scale_color_hue(labels = label_vec) + # 線の色:(数式表示用)
  theme(legend.text.align = 0) + # 図の体裁:凡例
  labs(title = "Gaussian Distribution", 
       x = "x", y = "density") # ラベル
```

　$\sigma$が小さいほど、山が細く高くなります。\
\


### 精度の影響

　$\mu$を固定し、$\sigma$の代わりに複数の$\lambda$を指定して、それぞれ分布を計算します。

```{r}
# 平均パラメータを指定
mu <- 0

# 標準偏差パラメータとして利用する値を指定
lambda_vals <- c(0.25, 0.5, 1, 2, 4)

# xの値を作成
sigma <- 1 / sqrt(min(lambda_vals))
x_vals <- seq(from = mu - sigma*3, to = mu + sigma*3, length.out = 250)

# パラメータごとにガウス分布を計算
res_dens_df <- tidyr::expand_grid(
  x = x_vals, 
  lambda = lambda_vals
) |> # 全ての組み合わせを作成
  dplyr::arrange(lambda, x) |> # パラメータごとに並べ替え
  dplyr::mutate(
    density = dnorm(x = x, mean = mu, sd = 1/sqrt(lambda)), 
    parameter = paste0("mu=", mu, ", lambda=", lambda) |> 
      factor(levels = paste0("mu=", mu, ", lambda=", sort(lambda_vals))) # フレーム切替用ラベル
  ) # 確率密度を計算
res_dens_df
```

　`x_vals`と`lambda_vals`の全ての組み合わせを作成して、同様に処理します。\

　作図については同じコードで処理できます。

```{r, echo=FALSE, fig.width=8, fig.height=6}
### 資料作成用:(再掲)

# 凡例用のラベルを作成:(数式表示用)
label_vec <- res_dens_df[["parameter"]] |> 
  stringr::str_replace_all(pattern = "=", replacement = "==") |> # 等号表示用の記法に変換
  (\(.){paste0("list(", ., ")")})() |> # カンマ表示用の記法に変換
  unique() |> # 重複を除去
  parse(text = _) # expression関数化
names(label_vec) <- unique(res_dens_df[["parameter"]]) # ggplotに指定する文字列に対応する名前付きベクトルに変換

# ガウス分布のアニメーションを作図
ggplot(data = res_dens_df, mapping = aes(x = x, y = density, color = parameter)) + # データ
  geom_line(size = 1) + # 折れ線グラフ
  scale_color_hue(labels = label_vec) + # 線の色:(数式表示用)
  theme(legend.text.align = 0) + # 図の体裁:凡例
  labs(title = "Gaussian Distribution", 
       x = "x", y = "density") # ラベル
```

　$\lambda$が大きいほど、山が細く高くなります。\
\


## パラメータと分布の形状の関係をアニメーションで可視化

　前節では、複数のパラメータのグラフを並べて比較しました。次は、パラメータの値を少しずつ変化させて、分布の形状の変化をアニメーションで確認します。\
\


### 平均の影響

　$\mu$の値を変化させ、$\sigma$を固定して、それぞれ分布を計算します。

```{r}
# 平均パラメータとして利用する値を指定
mu_vals <- seq(from = -5, to = 5, by = 0.1) # (線の変化用)
#mu_vals <- seq(from = -5, to = 5, by = 0.5) # (線の軌跡用)
length(mu_vals) # フレーム数

# 標準偏差パラメータを指定
sigma <- 1

# xの値を作成
x_vals <- seq(from = min(mu_vals)-sigma, to = max(mu_vals)+sigma, length.out = 251)

# パラメータごとにガウス分布を計算
anime_dens_df <- tidyr::expand_grid(
  x = x_vals, 
  mu = mu_vals
) |> # 全ての組み合わせを作成
  dplyr::arrange(mu, x) |> # パラメータごとに並べ替え
  dplyr::mutate(
    density = dnorm(x = x, mean = mu, sd = sigma), 
    parameter = paste0("mu=", round(mu, 2), ", sigma=", sigma) |> 
      factor(levels = paste0("mu=", round(mu_vals, 2), ", sigma=", sigma)) # フレーム切替用ラベル
  ) # 確率密度を計算
anime_dens_df
```

　値の間隔が一定になるように`a_vals`を作成します。パラメータごとにフレームを切り替えるので、`mu_vals`の要素数がアニメーションのフレーム数になります。\
　データフレームの変数名以外は「並べて比較」のときと同じ処理です。\

　ガウス分布のアニメーション(gif画像)を作成します。

```{r}
# ガウス分布のアニメーションを作図
anime_dens_graph <- ggplot(data = anime_dens_df, mapping = aes(x = x, y = density)) + # データ
  geom_line(color = "#00A968", size = 1) + # 折れ線グラフ
  gganimate::transition_manual(parameter) + # フレーム
  labs(title = "Gaussian Distribution", 
       subtitle = "{current_frame}") # ラベル

# gif画像を作成
gganimate::animate(anime_dens_graph, nframes = length(mu_vals), fps = 100, width = 800, height = 600)
```

　`transition_manual()`にフレームの順序を表す列を指定します。この例では、因子型のラベルのレベルの順に描画されます。\
　`animate()`のフレーム数の引数`nframes`にパラメータ数、フレームレートの引数`fps`に1秒当たりのフレーム数を指定します。`fps`引数の値が大きいほどフレームが早く切り替わります。ただし、値が大きいと意図通りに動作しません。\

　続いて、分布の変化の軌跡を描画するアニメーションを作成します。`mu_vals`の値の間隔を粗くしておきます。

```{r, echo=FALSE}
### 資料作成用:(再掲)

# 平均パラメータとして利用する値を指定
mu_vals <- seq(from = -5, to = 5, by = 0.5) # (線の軌跡用)

# 標準偏差パラメータを指定
sigma <- 1

# xの値を作成
x_vals <- seq(from = min(mu_vals)-sigma, to = max(mu_vals)+sigma, length.out = 251)

# パラメータごとにガウス分布を計算
anime_dens_df <- tidyr::expand_grid(
  x = x_vals, 
  mu = mu_vals
) |> # 全ての組み合わせを作成
  dplyr::arrange(mu, x) |> # パラメータごとに並べ替え
  dplyr::mutate(
    density = dnorm(x = x, mean = mu, sd = sigma), 
    parameter = paste0("mu=", round(mu, 2), ", sigma=", sigma) |> 
      factor(levels = paste0("mu=", round(mu_vals, 2), ", sigma=", sigma)) # フレーム切替用ラベル
  ) # 確率密度を計算
```

```{r}
# ガウス分布のアニメーションを作図
anime_dens_graph <- ggplot(data = anime_dens_df, mapping = aes(x = x, y = density, color = factor(mu), group = mu)) + # データ
  geom_line() + # 折れ線グラフ
  gganimate::transition_reveal(mu) + # フレーム
  labs(title = "Gaussian Distribution", 
       subtitle = paste0("mu={frame_along}, sigma=", sigma), 
       color = expression(mu), 
       x = "x", y = "density") # ラベル

# gif画像を作成
gganimate::animate(anime_dens_graph, nframes = length(mu_vals)+10, end_pause = 10, fps = 10, width = 800, height = 600)
```

　`transition_reveal()`を使ってフレームを切り替えると、過去フレームのグラフが表示され続けます。\
　`animate()`の`end_pause`引数を指定すると、最後のフレームでグラフが一時停止(最後のグラフを指定したフレーム数表示)します。\
\


### 標準偏差の影響

　続いて、$\mu$を固定し、$\sigma$の値を変化させて、それぞれ分布を計算します。

```{r}
# 平均パラメータを指定
mu <- 0

# 標準偏差パラメータとして利用する値を指定
sigma_vals <- seq(from = 0.5, to = 5, by = 0.1) # (線の変化用)
#sigma_vals <- seq(from = 0.5, to = 5, by = 0.5) # (線の軌跡用)
length(sigma_vals) # フレーム数

# xの値を作成
x_vals <- seq(from = mu - max(sigma_vals)*2, to = mu + max(sigma_vals)*2, length.out = 251)

# パラメータごとにガウス分布を計算
anime_dens_df <- tidyr::expand_grid(
  x = x_vals, 
  sigma = sigma_vals
) |> # 全ての組み合わせを作成
  dplyr::arrange(sigma, x) |> # パラメータごとに並べ替え
  dplyr::mutate(
    density = dnorm(x = x, mean = mu, sd = sigma), 
    parameter = paste0("mu=", mu, ", sigma=", round(sigma, 2)) |> 
      factor(levels = paste0("mu=", mu, ", sigma=", round(sigma_vals, 2))) # フレーム切替用ラベル
  ) # 確率密度を計算
anime_dens_df
```

　「並べて比較」や「平均の影響」と同様に処理します。\

　「平均の影響」のコードで作図できます。フレーム数は`sigma_vals`の要素数です。

```{r, echo=FALSE}
### 資料作成用:(再掲)

# ガウス分布のアニメーションを作図
anime_dens_graph <- ggplot(data = anime_dens_df, mapping = aes(x = x, y = density)) + # データ
  geom_line(color = "#00A968", size = 1) + # 折れ線グラフ
  gganimate::transition_manual(parameter) + # フレーム
  labs(title = "Gaussian Distribution", 
       subtitle = "{current_frame}") # ラベル
```

```{r}
# gif画像を作成
gganimate::animate(anime_dens_graph, nframes = length(sigma_vals), fps = 100, width = 800, height = 600)
```

\ 

　続いて、分布の変化の軌跡を描画するアニメーションを作成します。

```{r, echo=FALSE}
### 資料作成用:(再掲)

# 平均パラメータを指定
mu <- 0

# 標準偏差パラメータとして利用する値を指定
sigma_vals <- seq(from = 0.5, to = 5, by = 0.5) # (線の軌跡用)

# xの値を作成
x_vals <- seq(from = mu - max(sigma_vals)*2, to = mu + max(sigma_vals)*2, length.out = 251)

# パラメータごとにガウス分布を計算
anime_dens_df <- tidyr::expand_grid(
  x = x_vals, 
  sigma = sigma_vals
) |> # 全ての組み合わせを作成
  dplyr::arrange(sigma, x) |> # パラメータごとに並べ替え
  dplyr::mutate(
    density = dnorm(x = x, mean = mu, sd = sigma), 
    parameter = paste0("mu=", mu, ", sigma=", round(sigma, 2)) |> 
      factor(levels = paste0("mu=", mu, ", sigma=", round(sigma_vals, 2))) # フレーム切替用ラベル
  ) # 確率密度を計算
```

```{r}
# ガウス分布のアニメーションを作図
anime_dens_graph <- ggplot(data = anime_dens_df, mapping = aes(x = x, y = density, color = factor(sigma), group = sigma)) + # データ
  geom_line() + # 折れ線グラフ
  gganimate::transition_reveal(sigma) + # フレーム
  labs(title = "Gaussian Distribution", 
       subtitle = paste0("mu=", mu, ", sigma={frame_along}"), 
       color = expression(sigma), 
       x = "x", y = "density") # ラベル

# gif画像を作成
gganimate::animate(anime_dens_graph, nframes = length(sigma_vals)+10, end_pause=10, fps = 10, width = 800, height = 600)
```

　「平均の影響」の`mu`を`sigma`に置き換えて処理します。\
\


### 精度の影響

　$\mu$を固定し、$\sigma$の代わりに$\lambda$の値を変化させて、それぞれ分布を計算します。

```{r}
# 平均パラメータを指定
mu <- 0

# 標準偏差パラメータとして利用する値を指定
lambda_vals <- seq(from = 0.1, to = 10, by = 0.1) # (線の変化用)
#lambda_vals <- seq(from = 0.5, to = 7.5, by = 0.5) # (線の軌跡用)
length(lambda_vals) # フレーム数

# xの値を作成
sigma <- 1 / sqrt(min(lambda_vals))
x_vals <- seq(from = mu - sigma*2, to = mu + sigma*2, length.out = 250)

# パラメータごとにガウス分布を計算
anime_dens_df <- tidyr::expand_grid(
  x = x_vals, 
  lambda = lambda_vals
) |> # 全ての組み合わせを作成
  dplyr::arrange(lambda, x) |> # パラメータごとに並べ替え
  dplyr::mutate(
    density = dnorm(x = x, mean = mu, sd = 1/sqrt(lambda)), 
    parameter = paste0("mu=", mu, ", lambda=", round(lambda, 2)) |> 
      factor(levels = paste0("mu=", mu, ", lambda=", round(lambda_vals, 2))) # フレーム切替用ラベル
  ) # 確率密度を計算
anime_dens_df
```

　「並べて比較」や「平均の影響」と同様に処理します。\

　「平均の影響」のコードで作図できます。フレーム数は`lambda_vals`の要素数です。

```{r, echo=FALSE}
### 資料作成用:(再掲)

# ガウス分布のアニメーションを作図
anime_dens_graph <- ggplot(data = anime_dens_df, mapping = aes(x = x, y = density)) + # データ
  geom_line(color = "#00A968", size = 1) + # 折れ線グラフ
  gganimate::transition_manual(parameter) + # フレーム
  labs(title = "Gaussian Distribution", 
       subtitle = "{current_frame}") # ラベル
```

```{r}
# gif画像を作成
gganimate::animate(anime_dens_graph, nframes = length(lambda_vals), fps = 100, width = 800, height = 600)
```

\ 

　続いて、分布の変化の軌跡を描画するアニメーションを作成します。

```{r, echo=FALSE}
### 資料作成用:(再掲)

# 平均パラメータを指定
mu <- 0

# 標準偏差パラメータとして利用する値を指定
lambda_vals <- seq(from = 0.5, to = 7.5, by = 0.5) # (線の軌跡用)

# xの値を作成
sigma <- 1 / sqrt(min(lambda_vals))
x_vals <- seq(from = mu - sigma*4.5, to = mu + sigma*4.5, length.out = 250)

# パラメータごとにガウス分布を計算
anime_dens_df <- tidyr::expand_grid(
  x = x_vals, 
  lambda = lambda_vals
) |> # 全ての組み合わせを作成
  dplyr::arrange(lambda, x) |> # パラメータごとに並べ替え
  dplyr::mutate(
    density = dnorm(x = x, mean = mu, sd = 1/sqrt(lambda)), 
    parameter = paste0("mu=", mu, ", lambda=", round(lambda, 2)) |> 
      factor(levels = paste0("mu=", mu, ", lambda=", round(lambda_vals, 2))) # フレーム切替用ラベル
  ) # 確率密度を計算
```

```{r}
# ガウス分布のアニメーションを作図
anime_dens_graph <- ggplot(data = anime_dens_df, mapping = aes(x = x, y = density, color = factor(lambda), group = lambda)) + # データ
  geom_line() + # 折れ線グラフ
  gganimate::transition_reveal(lambda) + # フレーム
  labs(title = "Gaussian Distribution", 
       subtitle = paste0("mu=", mu, ", lambda={frame_along}"), 
       color = expression(lambda), 
       x = "x", y = "density") # ラベル

# gif画像を作成
gganimate::animate(anime_dens_graph, nframes = length(lambda_vals)+10, end_pause=10, fps = 10, width = 800, height = 600)
```

　「平均の影響」の`mu`を`lambda`に置き換えて処理します。\
\


## パラメータと統計量の関係をアニメーションで可視化

　ここまでは、パラメータと分布の関係を確認しました。次は、パラメータと統計量と歪度・尖度の関係をアニメーションで確認します。\
\


### 平均の影響

　「パラメータと分布の形状の関係」と同様に、$\mu$の値を変化させ、$\sigma$を固定して、`anime_dens_df`を作成します。\

```{r, echo=FALSE}
### 資料作成用:(再掲)

# 平均パラメータとして利用する値を指定
mu_vals <- seq(from = -5, to = 5, by = 0.1)

# 標準偏差パラメータを指定
sigma <- 1

# xの値を作成
x_vals <- seq(from = min(mu_vals)-sigma, to = max(mu_vals)+sigma, length.out = 251)

# パラメータごとにガウス分布を計算
anime_dens_df <- tidyr::expand_grid(
  x = x_vals, 
  mu = mu_vals
) |> # 全ての組み合わせを作成
  dplyr::arrange(mu, x) |> # パラメータごとに並べ替え
  dplyr::mutate(
    density = dnorm(x = x, mean = mu, sd = sigma), 
    parameter = paste0("mu=", round(mu, 2), ", sigma=", sigma) |> 
      factor(levels = paste0("mu=", round(mu_vals, 2), ", sigma=", sigma)) # フレーム切替用ラベル
  ) # 確率密度を計算
```

　パラメータごとに統計量を計算します。

```{r}
# パラメータごとに統計量を計算
anime_stat_df <- tibble::tibble(
  mean = mu_vals, # 期待値
  sd = sigma, # 標準偏差
  parameter = paste0("mu=", round(mu_vals, 2), ", sigma=", sigma) |> 
    factor(levels = paste0("mu=", round(mu_vals, 2), ", sigma=", sigma)) # フレーム切替用のラベル
) |> # 統計量を計算
  dplyr::mutate(
    sd_minus = mean - sd, 
    sd_plus = mean + sd
  ) |> # 期待値±標準偏差を計算
  dplyr::select(!sd) |> # 不要な列を削除
  tidyr::pivot_longer(
    cols = !parameter, 
    names_to = "type", 
    values_to = "statistic"
  ) |> # 統計量の列をまとめる
  dplyr::mutate(
    type = stringr::str_replace(type, pattern = "sd_.*", replacement = "sd")) # 期待値±標準偏差のカテゴリを統一
anime_stat_df
```

　期待値・標準偏差・最頻値を計算して、さらに期待値から標準偏差を引いた値と足した値を求めます。\
　期待値・標準偏差の和と差・最頻値の4つの列を`pivot_longer()`でまとめます。列名がラベルになるので、標準偏差の和と差のラベルを統一します。\

　線と凡例の設定用の名前付きベクトルを作成します。

```{r}
# 凡例用の設定を作成:(数式表示用)
color_vec    <- c(mean = "blue", sd = "orange")
linetype_vec <- c(mean = "dashed", sd = "dotted")
label_vec    <- c(mean = expression(E(x)), sd = expression(E(x) %+-% sqrt(V(x))))
```

　「グラフの作成」のときと同じ処理です。\

　統計量の情報を重ねたガンマ分布のアニメーション(gif画像)を作成します。

```{r}
# 統計量を重ねた分布のアニメーションを作図
anime_dens_graph <- ggplot() + 
  geom_line(data = anime_dens_df, mapping = aes(x = x, y = density), 
            color = "#00A968", size = 1) + # 分布
  geom_vline(data = anime_stat_df, mapping = aes(xintercept = statistic, color = type, linetype = type), 
             size = 1) + # 統計量
  gganimate::transition_manual(parameter) + # フレーム
  scale_color_manual(values = color_vec, labels = label_vec, name = "statistic") + # 線の色:(色指定と数式表示用)
  scale_linetype_manual(values = linetype_vec, labels = label_vec, name = "statistic") + # 線の種類:(線指定と数式表示用)
  guides(color = guide_legend(override.aes = list(size = 0.5))) + # 凡例の体裁
  theme(legend.text.align = 0) + # 図の体裁:凡例
  labs(title = "Gaussian Distribution", 
       subtitle = "{current_frame}") # ラベル

# gif画像を作成
gganimate::animate(anime_dens_graph, nframes = length(mu_vals), fps = 100, width = 800, height = 600) # (平均の影響の場合)
```

\ 


### 標準偏差の影響

　$\mu$を固定し、$\sigma$の値を変化させて、`anime_dens_df`を作成します。\

```{r, echo=FALSE}
### 資料作成用:(再掲)

# 平均パラメータを指定
mu <- 0

# 標準偏差パラメータとして利用する値を指定
sigma_vals <- seq(from = 0.5, to = 5, by = 0.1)

# xの値を作成
x_vals <- seq(from = mu - max(sigma_vals)*2, to = mu + max(sigma_vals)*2, length.out = 251)

# パラメータごとにガウス分布を計算
anime_dens_df <- tidyr::expand_grid(
  x = x_vals, 
  sigma = sigma_vals
) |> # 全ての組み合わせを作成
  dplyr::arrange(sigma, x) |> # パラメータごとに並べ替え
  dplyr::mutate(
    density = dnorm(x = x, mean = mu, sd = sigma), 
    parameter = paste0("mu=", mu, ", sigma=", round(sigma, 2)) |> 
      factor(levels = paste0("mu=", mu, ", sigma=", round(sigma_vals, 2))) # フレーム切替用ラベル
  ) # 確率密度を計算
```

　パラメータごとに統計量を計算します。

```{r}
# パラメータごとに統計量を計算
anime_stat_df <- tibble::tibble(
  mean = mu, # 期待値
  sd = sigma_vals, # 標準偏差
  parameter = paste0("mu=", mu, ", sigma=", round(sigma_vals, 2)) |> 
    factor(levels = paste0("mu=", mu, ", sigma=", round(sigma_vals, 2))) # フレーム切替用のラベル
) |> # 統計量を計算
  dplyr::mutate(
    sd_minus = mean - sd, 
    sd_plus = mean + sd
  ) |> # 期待値±標準偏差を計算
  dplyr::select(!sd) |> # 不要な列を削除
  tidyr::pivot_longer(
    cols = !parameter, 
    names_to = "type", 
    values_to = "statistic"
  ) |> # 統計量の列をまとめる
  dplyr::mutate(
    type = stringr::str_replace(type, pattern = "sd_.*", replacement = "sd")) # 期待値±標準偏差のカテゴリを統一
anime_stat_df
```

　「平均の影響」の`mu_vals`を`mu`、`sigma`を`sigma_vals`に置き換えるように処理します。\

　「平均の影響」のコードで作図できます。フレーム数は`sigma_vals`の要素数です。

```{r, echo=FALSE}
### 資料作成用:(再掲)

# 統計量を重ねた分布のアニメーションを作図
anime_dens_graph <- ggplot() + 
  geom_line(data = anime_dens_df, mapping = aes(x = x, y = density), 
            color = "#00A968", size = 1) + # 分布
  geom_vline(data = anime_stat_df, mapping = aes(xintercept = statistic, color = type, linetype = type), 
             size = 1) + # 統計量
  gganimate::transition_manual(parameter) + # フレーム
  scale_color_manual(values = color_vec, labels = label_vec, name = "statistic") + # 線の色:(色指定と数式表示用)
  scale_linetype_manual(values = linetype_vec, labels = label_vec, name = "statistic") + # 線の種類:(線指定と数式表示用)
  guides(color = guide_legend(override.aes = list(size = 0.5))) + # 凡例の体裁
  theme(legend.text.align = 0) + # 図の体裁:凡例
  labs(title = "Gaussian Distribution", 
       subtitle = "{current_frame}") # ラベル
```

```{r}
# gif画像を作成
gganimate::animate(anime_dens_graph, nframes = length(sigma_vals), fps = 100, width = 800, height = 600) # (標準偏差の影響の場合)
```

\ 


### 精度の影響

　$\mu$を固定し、$\sigma$の代わりに$\lambda$の値を変化させて、`anime_dens_df`を作成します。\

```{r, echo=FALSE}
### 資料作成用:(再掲)

# 平均パラメータを指定
mu <- 0

# 標準偏差パラメータとして利用する値を指定
lambda_vals <- seq(from = 0.1, to = 10, by = 0.1)

# xの値を作成
sigma <- 1 / sqrt(min(lambda_vals))
x_vals <- seq(from = mu - sigma*2, to = mu + sigma*2, length.out = 250)

# パラメータごとにガウス分布を計算
anime_dens_df <- tidyr::expand_grid(
  x = x_vals, 
  lambda = lambda_vals
) |> # 全ての組み合わせを作成
  dplyr::arrange(lambda, x) |> # パラメータごとに並べ替え
  dplyr::mutate(
    density = dnorm(x = x, mean = mu, sd = 1/sqrt(lambda)), 
    parameter = paste0("mu=", mu, ", lambda=", round(lambda, 2)) |> 
      factor(levels = paste0("mu=", mu, ", lambda=", round(lambda_vals, 2))) # フレーム切替用ラベル
  ) # 確率密度を計算
```

　パラメータごとに統計量を計算します。

```{r}
# パラメータごとに統計量を計算
anime_stat_df <- tibble::tibble(
  mean = mu, # 期待値
  sd = 1 / sqrt(lambda_vals), # 標準偏差
  parameter = paste0("mu=", mu, ", lambda=", round(lambda_vals, 2)) |> 
    factor(levels = paste0("mu=", mu, ", lambda=", round(lambda_vals, 2))) # フレーム切替用のラベル
) |> # 統計量を計算
  dplyr::mutate(
    sd_minus = mean - sd, 
    sd_plus = mean + sd
  ) |> # 期待値±標準偏差を計算
  dplyr::select(!sd) |> # 不要な列を削除
  tidyr::pivot_longer(
    cols = !parameter, 
    names_to = "type", 
    values_to = "statistic"
  ) |> # 統計量の列をまとめる
  dplyr::mutate(
    type = stringr::str_replace(type, pattern = "sd_.*", replacement = "sd")) # 期待値±標準偏差のカテゴリを統一
anime_stat_df
```

　「標準偏差の影響」の`sigma_vals`を`lambda_vals`に置き換えるように処理します。\

　「平均の影響」のコードで作図できます。フレーム数は`lambda_vals`の要素数です。

```{r, echo=FALSE}
# 統計量を重ねた分布のアニメーションを作図
anime_dens_graph <- ggplot() + 
  geom_line(data = anime_dens_df, mapping = aes(x = x, y = density), 
            color = "#00A968", size = 1) + # 分布
  geom_vline(data = anime_stat_df, mapping = aes(xintercept = statistic, color = type, linetype = type), 
             size = 1) + # 統計量
  gganimate::transition_manual(parameter) + # フレーム
  scale_color_manual(values = color_vec, labels = label_vec, name = "statistic") + # 線の色:(色指定と数式表示用)
  scale_linetype_manual(values = linetype_vec, labels = label_vec, name = "statistic") + # 線の種類:(線指定と数式表示用)
  guides(color = guide_legend(override.aes = list(size = 0.5))) + # 凡例の体裁
  theme(legend.text.align = 0) + # 図の体裁:凡例
  labs(title = "Gaussian Distribution", 
       subtitle = "{current_frame}") # ラベル

# gif画像を作成
gganimate::animate(anime_dens_graph, nframes = length(lambda_vals), fps = 100, width = 800, height = 600) # (精度の影響の場合)
```

\ 

　この記事では、1次元ガウス分布の作図を確認しました。次は、乱数を生成します。\
\


# 1次元ガウス分布の乱数生成

　1次元分布(Gaussian Distribution)の乱数を生成します。ガウス分布については「定義式の確認」を参照してください。\
\

　利用するパッケージを読み込みます。

```{r, eval=FALSE}
# 利用パッケージ
library(tidyverse)
library(gganimate)
```

```{r, echo=FALSE}
### 資料作成用

# チェック用
library(ggplot2)
```

　この記事では、基本的に`パッケージ名::関数名()`の記法を使うので、パッケージを読み込む必要はありません。ただし、作図コードがごちゃごちゃしないようにパッケージ名を省略しているため、`ggplot2`は読み込む必要があります。\
　`magrittr`パッケージのパイプ演算子`%>%`ではなく、ベースパイプ(ネイティブパイプ)演算子`|>`を使っています。`%>%`に置き換えても処理できます。\
　分布の変化をアニメーション(gif画像)で確認するのに`gganimate`パッケージを利用します。不要であれば省略してください。\
\


## サンプリング

　ガウス分布の乱数を生成します。\
\

　ガウス分布のパラメータ$\mu, \sigma$とデータ数$N$を設定します。

```{r}
# 平均パラメータを指定
mu <- 2

# 標準偏差パラメータを指定
sigma <- 2.5

# データ数(サンプルサイズ)を指定
N <- 1000
```

　平均パラメータ(実数)$\mu$、精度パラメータ(正の実数)$\sigma$とデータ数(サンプルサイズ)$N$を指定します。\

　ガウス分布に従う乱数を生成します。

```{r}
# ガウス分布に従う乱数を生成
x_n <- rnorm(n = N, mean = mu, sd = sigma)
head(x_n)
```

　ガウス分布の乱数は、`rnorm()`で生成できます。データ数(サンプルサイズ)の引数`n`に`N`、平均の引数`mean`に`mu`、標準偏差の引数`sd`に`sigma`を指定します。\
\


## 乱数の可視化

　サンプルのヒストグラムを作成します。

```{r, fig.width=8, fig.height=6}
# サンプルを格納
data_df <- tidyr::tibble(x = x_n)

# サンプルのヒストグラムを作成:度数
ggplot(data = data_df, mapping = aes(x = x, y = ..count..)) + # データ
  geom_histogram(bins = 30, fill = "#00A968") + # ヒストグラム
  labs(
    title = "Gaussian Distribution", 
    subtitle = paste0("mu=", mu, ", sigma=", sigma, ", N=", N), # (文字列表記用)
    #subtitle = parse(text = paste0("list(mu==", mu, ", sigma==", sigma, ", N==", N, ")")), # (数式表記用)
    x = "x", y = "frequency"
  ) # ラベル
```

　サンプルをデータフレームに格納して、`geom_histgram()`でヒストグラムを描画します。デフォルト(`y = ..count..`)では、度数のヒストグラムを作成します。集計の範囲については、バーの数の引数`bins`またはバーのサイズの引数`binwidth`を指定します。\

　ギリシャ文字などの記号を使った数式を表示する場合は、`expression()`の記法を使います。等号は`"=="`、複数の(数式上の)変数を並べるには`"list(変数1, 変数2)"`とします。(プログラム上の)変数の値を使う場合は、`parse()`の`text`引数に指定します。\
\

　サンプルの密度を確率分布と重ねて描画します。

```{r, fig.width=8, fig.height=6}
# xの値を作成
x_vals <- seq(from = mu-sigma * 4, to = mu+sigma * 4, length.out = 251)

# ガウス分布を計算
dens_df <- tidyr::tibble(
  x = x_vals, # 確率変数
  density = dnorm(x = x_vals, mean = mu, sd = sigma) # 確率密度
)

# サンプルのヒストグラムを作成:密度
ggplot() + 
  geom_histogram(data = data_df, mapping = aes(x = x, y = ..density..), 
                 bins = 30, fill = "#00A968") + # ヒストグラム
  geom_line(data = dens_df, mapping = aes(x = x, y = density), 
            color = "darkgreen", size = 1, linetype = "dashed") + # 元の分布
  labs(title = "Gaussian Distribution", 
       subtitle = parse(text = paste0("list(mu==", mu, ", sigma==", sigma, ", N==", N, ")")), # 数式で表示
       x = "x", y = "density") # ラベル
```

　`geom_histogram()`のy軸の引数`y`に`..density..`を指定すると、密度に変換したヒストグラムを描画します。\

　データ数(サンプルサイズ)が十分に増えると、ヒストグラムの形が分布の形に近付きます。\
\


## 乱数と分布の関係をアニメーションで可視化

　次は、サンプルサイズとヒストグラムの形状の関係をアニメーションで確認します。\
\

　パラメータ$\mu, \sigma$とデータ数$N$を指定して、ガウス分布の乱数を生成します。

```{r}
# 平均パラメータを指定
mu <- 2

# 標準偏差パラメータを指定
sigma <- 2.5

# データ数(フレーム数)を指定
N <- 100

# ガウス分布に従う乱数を生成
x_n <- rnorm(n = N, mean = mu, sd = sigma)
head(x_n)
```

　`x_n`の`n`番目の要素を、`n`回目にサンプリングされた値とみなします。アニメーションの`n`番目のフレームでは、`n`個のサンプル`x_n[1:n]`のヒストグラムを描画します。\

　サンプリング回数ごとに、それまでのサンプルを持つデータフレームを作成します。

```{r}
# サンプルを複製して格納
anime_freq_df <- tidyr::tibble(
  x = rep(x_n, times = N), # サンプル
  n = rep(1:N, times = N), # データ番号
  frame = rep(1:N, each = N) # フレーム番号
) |> 
  dplyr::filter(n <= frame) |> # サンプリング回数以前のサンプルを抽出
  dplyr::mutate(
    parameter = paste0("mu=", mu, ", sigma=", sigma, ", N=", frame) |> 
      factor(levels = paste0("mu=", mu, ", sigma=", sigma, ", N=", 1:N))
  ) # フレーム切替用ラベルを追加
anime_freq_df
```

　データ番号(`n`列)は`1`から`N`の整数が`N`回繰り返すように、フレーム番号(`frame`列)は`1`から`N`の整数が`N`個ずつ並ぶように作成します。サンプルはデータ番号に対応するように複製します。\
　フレーム番号ごとに、それ以下の番号のサンプルを`filter()`で抽出します。\
　フレーム番号をデータ番号として、フレーム切替用のラベル列を作成します。これにより、各フレーム(サンプリング回数)ごとにそれ以前のサンプルを使ってグラフを作成できます。ラベルが文字列型だと文字列の基準で順序が決まるので、因子型にしてサンプリング回数に応じたレベル(順序)を設定します。\

　このデータフレームは、ヒストグラムを描画するのに使います。\

　サンプルと対応するラベルをデータフレームに格納します。

```{r}
# サンプルを格納
anime_data_df <- tidyr::tibble(
  x = x_n, # サンプル
  n = 1:N, # データ番号
  parameter = paste0("mu=", mu, ", sigma=", sigma, ", N=", 1:N) |> 
    factor(levels = paste0("mu=", mu, ", sigma=", sigma, ", N=", 1:N)) # フレーム切替用ラベル
)
anime_data_df
```

　このデータフレームは、各サンプリングにおけるサンプルの値を描画するのに使います。\

　サンプルのヒストグラムのアニメーション(gif画像)を作成します。

```{r}
# サンプルのヒストグラムのアニメーションのアニメーションを作図:度数
anime_freq_graph <- ggplot() + # 
  geom_histogram(data = anime_freq_df, mapping = aes(x = x), 
                 breaks = seq(from = min(x_vals), to = max(x_vals), length.out = 30), 
                 fill = "#00A968") + # ヒストグラム
  geom_point(data = anime_data_df, mapping = aes(x = x, y = 0), 
             color = "orange", size = 6) + # サンプル
  gganimate::transition_manual(parameter) + # フレーム
  labs(title = "Gaussian Distribution", 
       subtitle = "{current_frame}", 
       x = "x", y = "frequency") # ラベル

# gif画像を作成
gganimate::animate(anime_freq_graph, nframes = N, fps = 10, width = 800, height = 600)
```

　集計範囲を固定するために、`geom_histogram()`の`breaks`引数に区切り位置を指定します。この例では、`seq()`を使って`x_vals`の最小値から最大値の範囲を`30`等分しています。\

　`transition_manual()`にフレームの順序を表す列を指定します。この例では、因子型のラベルのレベルの順に描画されます。\
　`animate()`のフレーム数の引数`nframes`にデータ数(サンプルサイズ)、フレームレートの引数`fps`に1秒当たりのフレーム数を指定します。`fps`引数の値が大きいほどフレームが早く切り替わります。\

　サンプルの密度を確率分布と重ねたアニメーションを作成します。

```{r}
# xの値を作成
x_vals <- seq(from = mu-sigma * 4, to = mu+sigma * 4, length.out = 251)

# ガウス分布を計算
dens_df <- tidyr::tibble(
  x = x_vals, # 確率変数
  density = dnorm(x = x_vals, mean = mu, sd = sigma) # 確率密度
)

# サンプルのヒストグラムのアニメーションのアニメーションを作図:密度
anime_freq_graph <- ggplot() + # 
  geom_histogram(data = anime_freq_df, mapping = aes(x = x, y = ..density..), 
                 breaks = seq(from = min(x_vals), to = max(x_vals), length.out = 30), 
                 fill = "#00A968") + # ヒストグラム
  geom_point(data = anime_data_df, mapping = aes(x = x, y = 0), 
             color = "orange", size = 6) + # サンプル
  geom_line(data = dens_df, mapping = aes(x = x, y = density), 
            color = "darkgreen", size = 1, linetype = "dashed") + # 元の分布
  gganimate::transition_manual(parameter) + # フレーム
  coord_cartesian(ylim = c(0, max(dens_df[["density"]])*2)) + # 軸の表示範囲
  labs(title = "Gaussian Distribution", 
       subtitle = "{current_frame}", 
       x = "x", y = "density") # ラベル

# gif画像を作成
gganimate::animate(anime_freq_graph, nframes = N, fps = 10, width = 800, height = 600)
```

　サンプルが増えるに従って、ヒストグラムが元の分布に近付くのを確認できます。\
\

　この記事では、1次元ガウス分布の乱数生成を確認しました。次は、ガウス分布から確率分布を生成します。\
\


# 1次元ガウス分布から確率分布の生成

　1次元ガウス分布(Gaussian Distribution)から1次元ガウス分布を生成します。ガウス分布については「定義式の確認」を参照してください。\
\

　利用するパッケージを読み込みます。

```{r, eval=FALSE}
# 利用パッケージ
library(tidyverse)
library(patchwork)
```

```{r, echo=FALSE}
### 資料作成用

# チェック用
library(ggplot2)
library(patchwork)
```

　この記事では、基本的に`パッケージ名::関数名()`の記法を使うので、パッケージを読み込む必要はありません。ただし、作図コードがごちゃごちゃしないようにパッケージ名を省略しているため、`ggplot2`は読み込む必要があります。\
　`magrittr`パッケージのパイプ演算子`%>%`ではなく、ベースパイプ(ネイティブパイプ)演算子`|>`を使っています。`%>%`に置き換えても処理できます。  
\


## 生成分布の設定

　まずは、パラメータの生成分布としてガウス分布を設定して、ガウス分布の平均パラメータを生成(サンプリング)します。生成分布を$\mathcal{N}(\mu | \mu_{\mathrm{gen}}, \sigma_{\mathrm{gen}}^2)$、生成された分布を$\mathcal{N}(x | \mu, \sigma^2)$で表すことにします。\
\

　ガウス分布(生成分布)のパラメータ$\mu_{\mathrm{gen}}, \sigma_{\mathrm{gen}}$とサンプルサイズ$N$を設定します。

```{r}
# パラメータを指定
mu_gen    <- 2
sigma_gen <- 2.5

# 分布の数(サンプルサイズ)を指定
N <- 10
```

　平均パラメータ(実数)$\mu_{\mathrm{gen}}$、精度パラメータ(正の実数)$\sigma_{\mathrm{gen}}$とデータ数(パラメータ数)$N$を指定します。\

　ガウス分布に従う乱数を生成します。

```{r}
# ガウス分布の平均パラメータを生成
mu_n <- rnorm(n = N, mean = mu_gen, sd = sigma_gen) |> # ガウス分布の乱数を生成
  sort() # 昇順に並べ替え

# パラメータを格納
param_df <- tibble::tibble(
  mu = mu_n, 
  parameter = round(mu_n, 3) |> 
    factor() # 色分け用ラベル
)
param_df
```

　ガウス分布の乱数は、`rnorm()`で生成できます。データ数(サンプルサイズ)の引数`n`に`N`、平均の引数`mean`に`mu_gen`、標準偏差の引数`sd`に`sigma_gen`を指定します。\

　生成した値をガウス分布の平均パラメータ$\mu$として使います。\

　ガウス分布を計算します。

```{r}
# muの値を作成
mu_vals <- seq(from = mu_gen - sigma_gen*3, to = mu_gen + sigma_gen*3, length.out = 250)

# 生成分布を計算
gaussian_gen_df <- tibble::tibble(
  mu = mu_vals, # 確率変数
  density = dnorm(x = mu_vals, mean = mu_gen, sd = sigma_gen) # 確率密度
)
gaussian_gen_df
```

　ガウス分布(生成分布)の確率変数がとり得る値$\mu$を作成して、確率密度を計算します。\
　ガウス分布の確率密度は、`dnorm()`で計算できます。確率変数の引数`x`に`x_vals`、平均の引数`mean`に`mu_gen`、標準偏差の引数`sd`に`sigma_gen`を指定します。\
　`mu_vals`と、`mu_vals`の各要素に対応する確率密度をデータフレームに格納します。\

　ガウス分布の期待値$\mathbb{E}[\mu]$を計算します。

```{r}
# 平均パラメータの期待値を計算
E_mu <- mu_gen
```

　サンプリングされたパラメータとその分布の基準を示すのに使います。\

　生成分布(ガウス分布)とパラメータのサンプルをプロットします。

```{r, fig.width=8, fig.height=6}
# 生成分布とパラメータのサンプルを作図
gaussian_gen_graph <- ggplot() + # データ
  geom_vline(xintercept = E_mu, 
             color = "red", size = 1, linetype = "dashed") + # パラメータの期待値
  geom_line(data = gaussian_gen_df, mapping = aes(x = mu, y = density), 
            color = "#00A968", size = 1) + # パラメータの生成分布
  geom_point(data = param_df, mapping = aes(x = mu, y = 0, color = parameter), 
             alpha = 0.8, size = 6, show.legend = FALSE) + # パラメータのサンプル
  guides(color = guide_legend(override.aes = list(size = 2, alpha = 1))) + # 凡例の体裁
  labs(
    title = "Gaussian Distribution", 
    subtitle = parse(
      text = paste0("list(mu[paste(g,e,n)]==", mu_gen, ", sigma[paste(g,e,n)]==", sigma_gen, ")"), 
    ), 
    color = expression(mu), 
    x = expression(mu), y = "density"
  ) # ラベル
gaussian_gen_graph
```

　期待値を破線で示します。\
\

　以上で、生成分布を設定して、パラメータを生成しました。次は、パラメータのサンプルを用いて、ガウス分布を作図します。\
\


## 分布の作図：ガウス分布

　次に、生成した値をガウス分布の平均パラメータとして利用します。グラフ作成については「ガウス分布の作図」を参照してください。\
\

　パラメータのサンプルごとにガウス分布を計算します。

```{r}
# 標準偏差パラメータを指定
sigma <- 1

# xの値を作成
x_vals <- mu_vals

# パラメータのサンプルごとにガウス分布を計算
res_gaussian_df <- tidyr::expand_grid(
  x = x_vals, 
  mu = mu_n
) |> # 全ての組み合わせを作成
  dplyr::arrange(mu, x) |> # パラメータごとに並べ替え
  dplyr::mutate(
    density = dnorm(x = x, mean = mu, sd = sigma), # 確率密度
    parameter = round(mu, 3) |> 
      factor() # 色分け用ラベル
  )
res_gaussian_df
```

　ガウス分布(生成された分布)の確率変数がとり得る値$x$を作成して`x_vals`とします。この例では、作図時に対応関係が分かりやすいように、`mu_vals`の値を使います。\
　`x_vals`と`mu_n`それぞれの要素の全ての組み合わせを`expand_grid()`で作成して、組み合わせごとに確率を計算します。\
　ガウス分布の確率密度を`dnorm()`で計算します。確率変数の引数`x`に`x_vals`の値、平均の引数`mean`に`mu_n`の値、標準偏差の引数`sd`に`sigma`を指定します。\

　ガウス分布(生成分布)の期待値(ガウス分布(生成された分布)の平均パラメータの期待値)を用いて、ガウス分布を計算します。

```{r}
# パラメータの期待値によるガウス分布を計算
E_gaussian_df <- tidyr::tibble(
  x = x_vals, # 確率変数
  density = dnorm(x = x_vals, mean = E_mu, sd = sigma) # 確率密度
)
E_gaussian_df
```

　`mean`引数に`E_mu`を指定します。\

　$N + 1$個のガウス分布を作図します。

```{r, fig.width=8, fig.height=6}
# サンプルと期待値によるガウス分布を作図
gaussian_graph <- ggplot() + 
  geom_line(data = E_gaussian_df, mapping = aes(x = x, y = density), 
            color = "red", size = 1, linetype = "dashed") + # 期待値による分布
  geom_line(data = res_gaussian_df, mapping = aes(x = x, y = density, color = parameter), 
            alpha = 0.8, size = 1) + # サンプルによる分布
  labs(
    title = "Gaussian Distribution", 
    subtitle = parse(text = paste0("list(E(mu)==", E_mu, ", sigma==", sigma, ")"), ), 
    color = expression(mu), 
    x = "x", y = "density"
  ) # ラベル
gaussian_graph
```

　期待値による分布を破線で示します。\

　パラメータの生成分布(ガウス分布)と生成された分布(ガウス分布)を並べて描画します。

```{r, fig.width=12, fig.height=12}
# グラフを並べて描画
gaussian_gen_graph / gaussian_graph + 
  patchwork::plot_layout(guides = "collect")
```

　`patchwork`パッケージの`/`演算子を使うと上下に並べて描画できます。\

　平均$\mu$が大きいほど、$x$が大きいほど確率密度が大きくなり、山が右に位置します。パラメータのサンプルの点と、分布のピークが対応しているのが分かります。\
\

　この記事では、1次元ガウス分布からの分布生成を確認しました。\
\


# 参考書籍{-}

- 須山敦志『ベイズ推論による機械学習入門』(機械学習スタートアップシリーズ)杉山将監修,講談社,2017年.
- C.M.ビショップ著,元田 浩・他訳『パターン認識と機械学習 上』丸善出版,2012年.

